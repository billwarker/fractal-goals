steps:
  # ==========================================
  # 1. Build Backend Image
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Backend'
    args: [
      'build', 
      '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-backend:$BUILD_ID',
      '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-backend:latest',
      '.'
    ]

  # ==========================================
  # 2. Build Frontend Image
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Frontend'
    args: [
      'build',
      '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-frontend:$BUILD_ID',
      '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-frontend:latest',
      '--build-arg', 'VITE_API_URL=https://fractal-backend-195572181270.us-east1.run.app/api',
      'client'
    ]

  # ==========================================
  # 3. Push Images to Artifact Registry
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Images'
    args: [
      'push', 
      '--all-tags', 
      '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-backend'
    ]
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Frontend'
    args: [
      'push', 
      '--all-tags', 
      '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-frontend'
    ]

  # ==========================================
  # 4. Run DB Migrations (Cloud Run Job)
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Update Migration Job'
    entrypoint: gcloud
    args: [
      'run', 'jobs', 'update', 'migrate-db',
      '--image', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-backend:$BUILD_ID',
      '--region', '$_REGION',
      '--set-secrets', 'DATABASE_URL=DATABASE_URL:latest',
      '--set-env-vars', 'FLASK_ENV=production',
      '--add-cloudsql-instances', 'fractal-goals:us-east1:fractal-goals-postgres',
      '--command', 'python',
      '--args', 'db_migrate.py,upgrade'
    ]
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Run Migrations'
    entrypoint: gcloud
    args: [
      'run', 'jobs', 'execute', 'migrate-db',
      '--region', '$_REGION',
      '--wait'
    ]

  # ==========================================
  # 5. Deploy to Cloud Run (Backend)
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Backend'
    entrypoint: gcloud
    args: [
      'run', 'deploy', 'fractal-backend',
      '--image', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-backend:$BUILD_ID',
      '--region', '$_REGION',
      '--platform', 'managed',
      '--allow-unauthenticated', # Remove if auth required
      '--set-secrets', 'DATABASE_URL=DATABASE_URL:latest,JWT_SECRET_KEY=JWT_SECRET_KEY:latest',
      '--set-env-vars', 'FLASK_ENV=production,CORS_ORIGINS=https://my.fractalgoals.com;https://fractal-frontend-195572181270.us-east1.run.app',
      '--add-cloudsql-instances', 'fractal-goals:us-east1:fractal-goals-postgres',
      '--service-account', 'fractal-runtime@fractal-goals.iam.gserviceaccount.com'
    ]

  # ==========================================
  # 6. Deploy to Cloud Run (Frontend)
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Frontend'
    entrypoint: gcloud
    args: [
      'run', 'deploy', 'fractal-frontend',
      '--image', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/fractal-frontend:$SHORT_SHA',
      '--region', '$_REGION',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--service-account', 'fractal-runtime@fractal-goals.iam.gserviceaccount.com'
    ]

# Global timeout
timeout: '1200s'

# Substitutions to be configured in Cloud Build Trigger
substitutions:
  _REGION: 'us-east1'
  _REPOSITORY: 'fractal-repo' # Artifact Registry Repository Name

options:
  default_logs_bucket_behavior: REGIONAL_USER_OWNED_BUCKET