============================= test session starts ==============================
platform darwin -- Python 3.13.0, pytest-7.4.3, pluggy-1.6.0 -- /Users/will/Projects/fractal-goals/fractal-goals-venv/bin/python3.13
cachedir: .pytest_cache
rootdir: /Users/will/Projects/fractal-goals
configfile: pytest.ini
plugins: flask-1.3.0, black-0.3.12, anyio-4.12.0, Faker-20.1.0, cov-4.1.0, asyncio-0.21.1, flake8-1.1.1, requests-mock-1.11.0
asyncio: mode=Mode.STRICT
collecting ... collected 1 item

tests/integration/test_goals_api.py::TestGoalCRUDEndpoints::test_create_goal DEBUG: creating NEW engine for URI: sqlite:////var/folders/cp/z9d7txd14rs6381w7m3fdt600000gn/T/tmpatzxm45d.db
DEBUG: returning CACHED engine for URI: sqlite:////var/folders/cp/z9d7txd14rs6381w7m3fdt600000gn/T/tmpatzxm45d.db
DEBUG: returning CACHED engine for URI: sqlite:////var/folders/cp/z9d7txd14rs6381w7m3fdt600000gn/T/tmpatzxm45d.db
DEBUGGING DB: Found 1 goals. IDs: ['734771db-62e3-4b1c-a249-accae167d2d2']
DEBUG: Looking for parent with ID: 734771db-62e3-4b1c-a249-accae167d2d2
DEBUG: Created goal 25a92190-0bee-4cfb-b545-ef645343fc8a
FAILED

=================================== FAILURES ===================================
____________________ TestGoalCRUDEndpoints.test_create_goal ____________________

self = <test_goals_api.TestGoalCRUDEndpoints object at 0x1066f0f50>
client = <FlaskClient <Flask 'tests.conftest'>>
sample_ultimate_goal = <UltimateGoal(id=734771db-62e3-4b1c-a249-accae167d2d2, name=Master Software Engineering)>

    def test_create_goal(self, client, sample_ultimate_goal):
        """Test creating a new goal."""
        payload = {
            'name': 'New Long Term Goal',
            'description': 'A new goal',
            'type': 'LongTermGoal',
            'parent_id': sample_ultimate_goal.id,
            'root_id': sample_ultimate_goal.id
        }
        response = client.post(
            '/api/goals',
            data=json.dumps(payload),
            content_type='application/json'
        )
        assert response.status_code == 201
        data = json.loads(response.data)
        assert data['name'] == 'New Long Term Goal'
        assert data['attributes']['type'] == 'LongTermGoal'
>       assert data['attributes']['parent_id'] == sample_ultimate_goal.id
E       KeyError: 'parent_id'

tests/integration/test_goals_api.py:118: KeyError

---------- coverage: platform darwin, python 3.13.0-final-0 ----------
Name                                  Stmts   Miss  Cover   Missing
-------------------------------------------------------------------
app.py                                   33     33     0%   6-76
blueprints/__init__.py                    0      0   100%
blueprints/activities_api.py            237    214    10%   24-34, 39-67, 72-91, 96-115, 120-141, 150-160, 165-230, 235-369, 374-389
blueprints/goals_api.py                 352    291    17%   28-36, 61-65, 72, 77-80, 102-105, 113-204, 210-247, 253-302, 309-342, 352-384, 390-424, 430-447, 453-465, 471-508, 514-534, 540-562, 568-604
blueprints/pages.py                      37     37     0%   6-97
blueprints/programs_api.py              352    352     0%   1-604
blueprints/sessions_api.py              311    282     9%   28-116, 125-161, 169-186, 195-213, 222-230, 235-248, 254-315, 321-397, 403-434, 443-470, 476-517, 523-549, 555-622
blueprints/templates_api.py              94     78    17%   24-36, 42-56, 62-96, 102-131, 137-157
blueprints/timers_api.py                143    129    10%   24-75, 80-141, 147-183, 190-264
config.py                                51     51     0%   6-91
models.py                               299     76    75%   156-213, 230, 262, 293, 315, 346-347, 379, 402, 426, 460, 487, 513, 526-530, 540, 550, 553, 558, 564-569, 572, 583, 587-594, 600-603
tests/__init__.py                         0      0   100%
tests/conftest.py                       122     46    62%   106, 142-180, 191-201, 207-247, 253-265, 271-284, 290-311, 320-353
tests/integration/test_goals_api.py     139     94    32%   28-32, 36-49, 53-57, 61-67, 71-72, 81-88, 92-93, 122-132, 136-148, 152-158, 162-168, 173-184, 194-208, 212-213, 222-234, 239-260, 270-284, 288-303, 314-318, 325-329
-------------------------------------------------------------------
TOTAL                                  2170   1683    22%
Coverage HTML written to dir htmlcov

FAIL Required test coverage of 80% not reached. Total coverage: 22.44%
=========================== short test summary info ============================
FAILED tests/integration/test_goals_api.py::TestGoalCRUDEndpoints::test_create_goal
============================== 1 failed in 0.34s ===============================
Exception ignored in: <sqlite3.Connection object at 0x106a84040>
ResourceWarning: unclosed database in <sqlite3.Connection object at 0x106a84040>
Exception ignored in: <sqlite3.Connection object at 0x1068573d0>
ResourceWarning: unclosed database in <sqlite3.Connection object at 0x1068573d0>
